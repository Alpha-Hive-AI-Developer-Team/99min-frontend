"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import DashboardLayout from "@/components/dashboard/DashboardLayout";
import SettingsHeader from "@/components/settings/SettingsHeader";
import UserProfileCard from "@/components/settings/UserProfileCard";
import SettingsSection from "@/components/settings/SettingsSection";
import SettingsItem from "@/components/settings/SettingsItem";
import LogOutButton from "@/components/settings/LogOutButton";
import ProfilePage from "@/components/settings/ProfilePage";
import NotificationsPage from "@/components/settings/NotificationsPage";
import LocationPage from "@/components/settings/LocationPage";
import PrivacyPage from "@/components/settings/PrivacyPage";
import HelpCenterPage from "@/components/settings/HelpCenterPage";
import PaymentMethodsPage from "@/components/settings/PaymentMethodsPage";
import ConfirmationModal from "@/components/shared/ConfirmationModal";
import { useProfile } from "@/hooks/UseProfile";
import { UpdateProfilePayload } from "@/utils/api/settings.api";
import { User, Bell, MapPin, CreditCard, Shield, HelpCircle, Lock } from "lucide-react";

const SettingsPage: React.FC = () => {
  const router = useRouter();
  const { profile } = useProfile();

  const [showProfile, setShowProfile] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [showLocation, setShowLocation] = useState(false);
  const [showPrivacy, setShowPrivacy] = useState(false);
  const [showHelpCenter, setShowHelpCenter] = useState(false);
  const [showPaymentMethods, setShowPaymentMethods] = useState(false);
  const [isLogoutModalOpen, setIsLogoutModalOpen] = useState(false);

  const handleLogout = () => {
    router.push("/auth/login");
  };

  const handleProfileSubmit = (data: UpdateProfilePayload) => {
    setShowProfile(false);
  };

  if (showProfile) {
    return (
      <DashboardLayout>
        <ProfilePage onBack={() => setShowProfile(false)} onSubmit={handleProfileSubmit} />
      </DashboardLayout>
    );
  }

  if (showNotifications) {
    return (
      <DashboardLayout>
        <NotificationsPage onBack={() => setShowNotifications(false)} />
      </DashboardLayout>
    );
  }

  if (showLocation) {
    return (
      <DashboardLayout>
        <LocationPage onBack={() => setShowLocation(false)} />
      </DashboardLayout>
    );
  }

  if (showPrivacy) {
    return (
      <DashboardLayout>
        <PrivacyPage onBack={() => setShowPrivacy(false)} />
      </DashboardLayout>
    );
  }

  if (showHelpCenter) {
    return (
      <DashboardLayout>
        <HelpCenterPage onBack={() => setShowHelpCenter(false)} />
      </DashboardLayout>
    );
  }

  if (showPaymentMethods) {
    return (
      <DashboardLayout>
        <PaymentMethodsPage onBack={() => setShowPaymentMethods(false)} />
      </DashboardLayout>
    );
  }

  // Derive display values from real profile data
  const displayName = profile?.name ?? "â€”";
  const displayInitial = profile?.name?.[0]?.toUpperCase() ?? "?";

  return (
    <DashboardLayout>
      <div className="min-h-screen bg-inputBg">
        <div className="max-w-4xl bg-white mx-auto px-4">
          <SettingsHeader />

          {/*
            FIX: Old code passed an `avatar` prop that UserProfileCard didn't accept,
            and the old UserProfileCard required `email` which was never available here.
            Now UserProfileCard accepts optional `email` and optional `avatar`.
          */}
          <UserProfileCard
            name={displayName}
            initial={displayInitial}
            avatar={profile?.avatar}
          />

          {/* ACCOUNT */}
          <SettingsSection title="ACCOUNT">
            <div className="px-4">
              <SettingsItem
                icon={<User className="w-5 h-5" />}
                label="Profile"
                onClick={() => setShowProfile(true)}
              />
            </div>
            <div className="px-4">
              <SettingsItem
                icon={<Bell className="w-5 h-5" />}
                label="Notifications"
                onClick={() => setShowNotifications(true)}
              />
            </div>
            <div className="px-4">
              <SettingsItem
                icon={<MapPin className="w-5 h-5" />}
                label="Location"
                onClick={() => setShowLocation(true)}
              />
            </div>
          </SettingsSection>

          {/* BILLING */}
          <SettingsSection title="BILLING">
            <div className="px-4">
              <SettingsItem
                icon={<CreditCard className="w-5 h-5" />}
                label="Payment Methods"
                onClick={() => setShowPaymentMethods(true)}
              />
            </div>
            <div className="px-4">
              <SettingsItem
                icon={<Shield className="w-5 h-5" />}
                label="Subscriptions"
                href="/dashboard/subscriptions"
              />
            </div>
          </SettingsSection>

          {/* SUPPORT */}
          <SettingsSection title="SUPPORT">
            <div className="px-4">
              <SettingsItem
                icon={<HelpCircle className="w-5 h-5" />}
                label="Help Center"
                onClick={() => setShowHelpCenter(true)}
              />
            </div>
            <div className="px-4">
              <SettingsItem
                icon={<Lock className="w-5 h-5" />}
                label="Privacy & Safety"
                onClick={() => setShowPrivacy(true)}
              />
            </div>
          </SettingsSection>

          <div className="mb-8">
            <LogOutButton onClick={() => setIsLogoutModalOpen(true)} />
          </div>

          <div className="text-center">
            <p className="text-textGray text-xs">Version 1.0.0</p>
          </div>
        </div>
      </div>

      <ConfirmationModal
        isOpen={isLogoutModalOpen}
        onClose={() => setIsLogoutModalOpen(false)}
        onConfirm={handleLogout}
        title="Log Out"
        description="Are you sure you want to log out?"
        confirmText="Log Out"
        cancelText="Cancel"
      />
    </DashboardLayout>
  );
};

export default SettingsPage;